<?xml version="1.0"?>

<!--
    This build file contains targets useful for upgrading from uPortal
    2.1 to uPortal 2.3.  It is possible to perform this upgrade
    with either of these scenarios:

    1) Simple uPortal 2.1-style layouts along with "nested tables"-based theme.
    2) Aggregated layouts along with "integrated modes"-based theme.
   
    For more information on the usage of upgrade21.xml, please see
    http://www.uportal.org/implementors/upgrade/upgrade21.html
      
    Author: Al Wold (ASU), Nick Bolton (Unicon)
    Version: $Revision$
-->
<project name="upgrade21" default="upgrade21">
<import file="build.xml"/>

  <target name="upgrade21" depends="compile" 
   description="Runs all the targets necessary to upgrade the portal database">
    <echo message="Initializing uPortal"/>
    <antcall target="upgradedb"/>
    <antcall target="i18n-db"/>
    <antcall target="pubchan">
      <param name="channel" value="layout-sitemap.xml"/>
    </antcall>
    <antcall target="dbconvert21"/>
    <echo message="Finished initializing uPortal"/>
  </target>

 <target name="convert-to-al" depends="compile"
   description="Runs all the targets necessary to upgrade the portal database to use aggregated layouts">
    <echo message="Converting to Aggregated Layouts"/>
    <antcall target="pushfragment">
      <param name="fragmentFile" value="/properties/al/pushfragments.xml"/>
    </antcall>
    <antcall target="convertprofiles"/>
    <antcall target="convertlayouts">
      <param name="allLayouts" value="-all"/>
    </antcall>
 </target>

 <target name="upgradedb" depends="compile">
    <echo message="Invoking DbLoader"/>
    <property name="usetable" value=" "/>
    <property name="tablefile" value=" "/>
    <property name="usedata" value=" "/>
    <property name="datafile" value=" "/>
    <property name="createscript" value=" "/>
    <property name="droptables" value="-nD"/>
    <property name="createtables" value=" "/>
    <property name="populatetables" value=" "/>
    <property name="localeaware" value=" "/>
    <property name="adminlocale" value=" "/>
    <property name="upgrade" value="-u"/>
    <property name="upgradeVersion" value="2.1"/>
    <java fork="true" dir="${basedir}" classname="org.jasig.portal.tools.dbloader.DbLoader">
      <classpath>
        <pathelement path="${build.home}/WEB-INF/classes"/>
        <path refid="compile.classpath"/>
      </classpath>
                                                                                                                 
      <arg value="${usetable}"/>
      <arg value="${tablefile}"/>
      <arg value="${usedata}"/>
      <arg value="${datafile}"/>
      <arg value="${createscript}"/>
      <arg value="${droptables}"/>
      <arg value="${createtables}"/>
      <arg value="${populatetables}"/>
      <arg value="${localeaware}"/>
      <arg value="${adminlocale}"/>
      <arg value="${upgrade}"/>
      <arg value="${upgradeVersion}"/>
    </java>
 </target>
 
 <target name="convertprofiles" depends="compile">
  <java fork="false" classname="org.jasig.portal.tools.ConvertProfilesToAL">
   <classpath>
    <pathelement path="${build.home}/WEB-INF/classes"/>
    <path refid="compile.classpath"/>
   </classpath>
  </java>
 </target>

 <target name="convertlayouts" depends="compile">
  <property name="allLayouts" value=""/>
  <property name="userId" value=""/>
  <property name="profileId" value=""/>
  <java fork="false" classname="org.jasig.portal.tools.SimpleLayout2ALIM">
   <classpath>
    <pathelement path="${build.home}/WEB-INF/classes"/>
    <path refid="compile.classpath"/>
   </classpath>
   <arg value="${allLayouts}"/>
   <arg value="${userId}"/>
   <arg value="${profileId}"/>
  </java>
 </target>

<!-- ==================== DbConvert21 Target ================================= -->

<!--

  The "DbConvert21" target runs uPortal's DbConvert21 program to convert
  uPortal 2.1 database to 2.2+

  The DbConvert21 tool will add the top level folder to an existing stored layout allowing the
  layout to be used correctly in the 2.2, 2.3 portal

-->


  <target name="dbconvert21" depends="compile"
   description="converts database from 2.1 to 2.2 / 2.3">
    <echo message="Invoking DbConvert21"/>
    <java fork="true" dir="${basedir}" classname="org.jasig.portal.tools.DbConvert21">
      <classpath>
        <pathelement path="${build.home}/WEB-INF/classes"/>
        <path refid="compile.classpath"/>
      </classpath>
    </java>
  </target>


</project>
